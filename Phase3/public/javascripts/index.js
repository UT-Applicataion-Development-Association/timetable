/*var csc108l0101 = {
	_id: "csc108",
	tittle:'',
	description:'',
	sectionCode: "L0101",
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 16,
		end: 17,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 16,
		end: 17,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 16,
		end: 17,
		type: "tut"
	}],
	score: 5
}
var csc108l0102 = {
	_id: "csc108",
	sectionCode: "L0102",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 11,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 11,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 1,
		type: "tut"
	}],
	score: 4
}
var csc108l0201 = {
	_id: "csc108",
	sectionCode: "L0201",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 13,
		end: 14,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 13,
		end: 14,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 13,
		end: 14,
		type: "tut"
	}],
	score: 3
}
var csc108l0501 = {
	_id: "csc108",
	sectionCode: "L0501",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 18,
		end: 21,
		type: "lec"
	}],
	score: 3
}
var csc165l0101 = {
	_id: "csc165",
	sectionCode: "L0101",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 11,
		end: 13,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 11,
		end: 12,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 11,
		end: 13,
		type: "tut"
	}],
	score: 0
}
var csc165l0201 = {
	_id: "csc165",
	sectionCode: "L0201",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 14,
		end: 16,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 12,
		end: 13,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 14,
		end: 16,
		type: "tut"
	}],
	score: 0
}
var mat137l0101 = {
	_id: "mat137",
	sectionCode: "L0101",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 9,
		end: 10,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 9,
		end: 10,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 9,
		end: 10,
		type: "tut"
	}],
	score: 0
}
var mat137l0201 = {
	_id: "mat137",
	sectionCode: "L0201",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 11,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 11,
		type: "lec"
	},{
		weekday: "fri",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 11,
		type: "tut"
	}],
	score: 0
}
var mat223l0101 = {
	_id: "mat223",
	sectionCode: "L0101",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "tue",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 12,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 14,
		end: 15,
		type: "tut"
	}],
	score: 0
}
var mat223l0102 = {
	_id: "mat223",
	sectionCode: "L0102",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "tue",
		instructor: "Dianne",
		location: "BA1070",
		start: 10,
		end: 12,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 13,
		end: 14,
		type: "tut"
	}],
	score: 0
}
var phl245l0101 = {
	_id: "phl245",
	sectionCode: "L0101",
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 14,
		end: 16,
		type: "lec"
	},{
		weekday: "wed",
		instructor: "Dianne",
		location: "BA1070",
		start: 14,
		end: 15,
		type: "lec"
	}],
	score: 0
}
var phl246l5101 = {
	_id: "phl246",
	sectionCode: "L5101",
	tittle:'',
	description:'',
	timeslots: [{
		weekday: "mon",
		instructor: "Dianne",
		location: "BA1070",
		start: 18,
		end: 21,
		type: "lec"
	}],
	score: 0
}
var solutionlist = [
		[csc108l0101, csc165l0101, mat137l0101, mat223l0102, phl245l0101, phl246l5101], // solution_one, best
		[csc108l0101, csc165l0101, mat137l0201, mat223l0102, phl245l0101, phl246l5101], // solution_two
		[csc108l0102, csc165l0101, mat137l0101, mat223l0102, phl245l0101, phl246l5101], // solution_three
		[csc108l0501, csc165l0101, mat137l0101, mat223l0102, phl245l0101, phl246l5101], // solution_four
		[csc108l0501, csc165l0101, mat137l0201, mat223l0102, phl245l0101, phl246l5101]	// solution_five, worse
	];*/
	
var solutionlist;
// index of current solution
var cur;
var currentlist;
var convert_weekday = { "mon": 1,"tue": 2,"wed": 3,"thu": 4,"fri": 5};
var back = ["PaleGoldenRod","lightblue","LightSalmon", "lightgreen", "lightpink", "Chocolate", "GreenYellow", "GoldenRod"];
var option_back = ["MediumPurple", "Fuchsia", "Aqua"];
// count number for option
var cnt;
// check if two course overlap
var over_lap = function(a, b) {
	for (var i = 0; i < a.length; i++) {
		for (var j = 0; j < b.length; j++) {
			if (a[i].weekday == b[j].weekday && 
				Math.max(a[i].start, b[j].start) 
				< Math.min(a[i].end, b[j].end))
				return true;
		}
	}
	return false;
};

var draw_option = function(course) {
	var color = option_back[Math.floor(Math.random() * option_back.length)];
    for (var i = 0; i < course.timeslots.length; i++) {
    	var col_num = convert_weekday[course.timeslots[i].weekday];
    	for (var j = course.timeslots[i].start-7; j < course.timeslots[i].end-7; j++) {
    		var k = $(".timetable tbody tr:nth-of-type(" + j + ") td:eq(" + col_num + ")");
    		if (k.hasClass("course"))
    			return;
    		k.addClass("course").css("background-color", color);
    		if (j == course.timeslots[i].start-7) {
    			k.text("option " + cnt).on("click", function() {
    				for (var i = 0; i < currentlist.length; i++)
    					if (currentlist[i].courseCode == course.courseCode) {
    						currentlist.splice(i, 1, course);
    						clear_table();
    						render_solution(cur);
    						break;
    					}
    			});
    		}
    	}
	}
	cnt++;
};

var draw_course = function(course) {
	if (course.hasOwnProperty('color') == false) 
		course.color = back[Math.floor(Math.random() * back.length)]
    for (var i = 0; i < course.timeslots.length; i++) {
    	var col_num = convert_weekday[course.timeslots[i].weekday];
    	for (var j = course.timeslots[i].start-7; j < course.timeslots[i].end-7; j++) {
    		var k = $(".timetable tbody tr:nth-of-type(" + j + ") td:eq(" + col_num + ")");
    		k.addClass("course").css("background-color", course.color);
    		if (j == course.timeslots[i].start-7) {
    			k.text(course.courseCode);
    			k.on("click", function() {
    				clear_table();
    				render_solution(cur);
    				cnt = 1;
    				for (var i = 0; i < solutionlist.length; i++) 
    					for (var j = 0; j < solutionlist[i].length; j++) {
    						if (solutionlist[i][j].courseCode != course.courseCode ||
    							solutionlist[i][j] == course)
    							continue;
    						var success = true;
    						for (var k = 0; k < currentlist.length; k++)
    							if (over_lap(solutionlist[i][j], currentlist[k])) {
    								success = false;
    								break;
    							}
    						if (success) 
    							draw_option(solutionlist[i][j]);
    					}
    			});
    		}
    	}
	}
};
var remove_course = function(course) {
    for (var i = 0; i < course.timeslots.length; i++) {
    	var col_num = convert_weekday[course.timeslots[i].weekday];
    	for (var j = course.timeslots[i].start-7; j < course.timeslots[i].end-7; j++) {
    		var k = $(".timetable tbody tr:nth-of-type(" + j + ") td:eq(" + col_num + ")");
    		k.removeClass("course").css("background-color", "white");
    		if (j == course.timeslots[i].start-7)
    			k.text("").unbind("click");
    	}
	}
};

var clear_table = function() {
	var k = $(".timetable tbody tr").find("td:gt(0)");
    k.removeClass("course").css("background-color", "white");
    k.text("").unbind("click");
};

var render_solution = function(index) {
	var solution = solutionlist[index];
	for (var i = 0; i < currentlist.length; i++) 
		remove_course(currentlist[i]);
	currentlist = solution;
	cur = index;
	for (var i = 0; i < solution.length; i++) 
		draw_course(solution[i]);
};
var course_object;

$(document).ready(function(){

    //normal search area is initially hidden
    $('#normal-search-result').hide();
    $("#show-advanced").on("click", function() {
        $(".advanced-search").toggleClass("hide");
    });
    $("#smart").on("click", function() {
        $(".right-bar").toggleClass("hide");
        $("#smart").toggleClass("button-position");
        $(".main").toggleClass("main-size");
        $(".arrowright").toggleClass("movearrow");
    });
    $("#getSolutions").on("click", function() {
    	$.get('/smart', function(data) {
           	solutionlist = data;
           	cur = 0;
           	currentlist = solutionlist[cur];
           	render_solution(cur);
           	$("#solutions table").empty();
           	for (var i = 0; i < solutionlist.length; i++)
           		$("#solutions table").append("<tr class='solution'><td>Solution " + (i+1) + "</td></tr>");
           	$("#solutions td").on("click", function() {
  				render_solution($("#solutions td").index(this));
  			});
  			$("#switch-left").on("click",function() {
				render_solution((cur-1+solutionlist.length)%solutionlist.length);
			});
			$("#switch-right").on("click",function() {
				render_solution((cur+1)%solutionlist.length);
			});
        });
	});
    /*
     * When 'x' is pressed, delete that particular course off
     * 'Course List' table
     */
     $(document).on("click", ".delete", function() {
       //var className = $(this).attr('class');
       $(this).parents('tr').remove();

     });
    /*
     * When click one of the search result, save the clicked section into
     * 'Course List' table
     * Also add the course into user's database
     */
     $(document).on("click", "#normal-search-result li", function(){
       //add new tr to the table
       var new_tr = document.createElement('tr');
       new_tr.classList.add('course-item');
       $('#course-list-table').append(new_tr);

       //add new td to the tr
       var new_td = document.createElement('td');
       new_tr.append(new_td);

       //add new div to the td
       var new_div = document.createElement('div');
       new_div.id = course_object.id;
       new_div.innerHTML = this.innerHTML;
       new_td.append(new_div);

       //add a new delete button to td
       var new_delete = document.createElement('button');
       new_delete.classList.add('delete');
       new_delete.innerHTML = 'x';
       new_td.append(new_delete);

       //add course into user's databse
       var name = localStorage.getItem("username");
       var url = 'http://localhost:3000/users/info/' + name + '/addUserCourse';
       $.post(url,
         {
           courseCode: course_object.courseCode,
           semester: course_object.semester,
           type: course_object.type,
           sectionCode: course_object.sectionCode,
           instructor: course_object.instructor
         }, function(data, status) {
           console.log(data);
           console.log(status);
          //  alert("Data:" + data + "\nStatus" + status);
         });
     });
    /* Display all sections of courses searched
     * after typing some string inside search bar and press "search"
     */
    $('#normal-search').click(function() {
      var course_code = $('#search-by-coursecode').val();

      var url = 'http://localhost:3000/courses/' + course_code + '?callback=?';

      $('#normal-search-result').empty();
      $.getJSON(url, function(result) {
        //response data are now in the result variable
        //result = array of objects
        // everytime search is clicked show #normal-search-result
        $('#normal-search-result').show();

        var len = result.length;
        for (i = 0; i < len; i++) {
          var classItem = result[i];
          var newList = document.createElement('li');

          newList.id = 'classItem' + '000' + i;
          newList.classList.add('foo');
          var len2 = classItem.sections.length;
          if (len2 > 0) {
            for (n = 0; n < len2; n++) {
              course_object = {
                courseCode: classItem.sections[n].courseCode,
                semester: classItem.sections[n].semester,
                type: classItem.sections[n].type,
                sectionCode: classItem.sections[n].sectionCode,
                instructor: classItem.sections[n].instructor
              };
              newList.innerHTML = classItem.sections[n].courseCode +
                                  classItem.sections[n].semester +
                                  classItem.sections[n].type +
                                  classItem.sections[n].sectionCode +
                                  classItem.sections[n].instructor;
            }
          }
          else {
            newList.innerHTML = classItem._id;
          }
          $("#normal-search-result").append(newList);
          console.log(classItem);
        }
      });
    });

    /*
     *每次点body都会清空resultList and hide search result
     */
    $(document).on("click", "body", function(){
      $('#normal-search-result').empty();
      $('#normal-search-result').hide();
    });
});
